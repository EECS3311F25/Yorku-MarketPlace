<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 h-screen flex flex-col">

<div class="flex flex-col h-full max-w-3xl mx-auto w-full bg-white shadow-xl">

    <div class="p-4 bg-white border-b flex items-center justify-between z-10">
        <div>
            <h1 class="text-xl font-bold">Chat</h1>
            <p class="text-sm text-gray-500" th:text="'Listing ID: ' + ${listingId}"></p>
        </div>
        <a href="/inbox" class="text-blue-600 hover:underline">Back to Inbox</a>
    </div>

    <div id="chatArea" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">

        <div th:each="msg : ${chatHistory}"
             class="flex w-full"
             th:classappend="${msg.sender.id == currentUserId} ? 'justify-end' : 'justify-start'">

            <div class="max-w-[70%] px-4 py-2 rounded-lg text-white"
                 th:classappend="${msg.sender.id == currentUserId} ? 'bg-blue-600' : 'bg-gray-600'">
                <span th:text="${msg.content}"></span>
            </div>
        </div>

    </div>

    <div class="p-4 bg-white border-t flex items-center gap-2">
        <input id="messageInput"
               type="text"
               class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="Type a message..."
               onkeydown="if(event.key === 'Enter') sendMessage()">
        
        <button onclick="sendMessage()"
                class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">
            Send
        </button>
    </div>

</div>

<script th:inline="javascript">
    /* Inject variables from Spring Controller */
    const chatId = /*[[${chatId}]]*/ 'default_room';
    const currentUserId = /*[[${currentUserId}]]*/ 0;
    const otherUserId = /*[[${otherUserId}]]*/ 0;
    const listingId = /*[[${listingId}]]*/ 0;

    var stompClient = null;

    function connect() {
        // Connect to the endpoint defined in WebSocketConfig
        var socket = new SockJS('/ws-chat'); 
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log("Connected: " + frame);

            // Subscribe to the specific topic for this chat pair
            stompClient.subscribe('/topic/chat/' + chatId, function (messageOutput) {
                showMessage(JSON.parse(messageOutput.body));
            });
        });
    }

    function sendMessage() {
        const input = document.getElementById("messageInput");
        const text = input.value.trim();
        if (text === "") return;

        // Construct DTO
        const msg = {
            chatId: chatId,
            senderId: currentUserId,
            receiverId: otherUserId,
            content: text
        };

        // Send to Controller
        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(msg));
        input.value = "";
    }

    // Append a NEW message (Real-time)
    function showMessage(msg) {
        const chatArea = document.getElementById("chatArea");
        const wrapper = document.createElement("div");

        // Determine alignment
        const isMine = (msg.senderId === currentUserId);
        wrapper.className = "flex w-full " + (isMine ? "justify-end" : "justify-start");

        wrapper.innerHTML = `
            <div class="max-w-[70%] px-4 py-2 rounded-lg text-white ${isMine ? 'bg-blue-600' : 'bg-gray-600'}">
                ${msg.content}
            </div>
        `;

        chatArea.appendChild(wrapper);
        scrollToBottom();
    }

    function scrollToBottom() {
        const chatArea = document.getElementById("chatArea");
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    // Initialize
    window.onload = function() {
        connect();
        scrollToBottom(); // Scroll to bottom on initial load
    };
</script>

</body>
</html>